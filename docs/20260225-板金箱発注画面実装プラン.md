# 板金箱セミカスタム発注画面 実装プラン

## 1. 目的と概要
`docs\20260217-演算定義.md` で定義された「完全な例：板金箱のセミカスタム製品」のJSONコンフィグを用いて、ユーザーが寸法や色をブラウザ上で動的に変更しながら3Dモデルをプレビューできる発注画面を実装する。

## 2. システム構成・コンポーネント設計

### 2.1. `widget/src/Lambda360Order.tsx`
全体のJSON定義を受け取り、3Dビューワーとパラメータ入力フォームを統合したコンポーネント。

**Props:**
```typescript
interface Lambda360OrderProps {
  order: OrderConfig; // params, shape, pricing などの全体JSON
}
```

**機能:**
- **状態管理 (State):** `order.params` に定義された各変数の現在値（初期値は `default`）を `useState` で管理する。
- **フォーム生成 (UI):** `order.params` の `constraint`（`min/max/step`、または `enum`）を解析し、以下のフォームコントロールを動的生成する。
  - `min/max` の場合: スライダー（`<input type="range">`）
  - `enum` の場合: セレクトボックス（`<select>`）またはボタン群
  - `type="color"` の場合: カラーピッカー
- **式の評価とビューワーへの結合:** 
  ユーザー操作でパラメータが変わるたびに、`order.shape` 内部に記述された式文字列（例: `"$width - 200"`, `"$color"`）を現在の変数状態で評価し、実数値に置き換えた新しい `shape` オブジェクトを生成する。式の評価には簡易なパーサや関数化を用いる。
- **ビューワーの描画:** 
  評価済みの `shape` を既存の `<Lambda360Shape config={evaluatedShape} />` に渡し、3Dモデルを再描画する。

### 2.2. `frontend/app/order1/page.tsx`
`Lambda360Order` コンポーネントを使用し、実際の「板金箱発注ページ」となるNext.jsの画面。

**機能:**
- クライアントコンポーネント（`"use client"`）として実装する。
- 画面内でドキュメントにある「板金箱セミカスタム」のJSON定義をハードコード・定数化する。
- ページ上にタイトルと `<Lambda360Order order={板金箱JSON} />` を配置し、発注体験を再現する。
- レイアウトは、左側（または上部）に3Dビュー、右側（または下部）にパラメータ調整フォームといった製品コンフィギュレータの標準的なデザインを踏襲する。

### 2.3. 例とするJSONデータ
`docs\20260217-演算定義.md` の第4項に記載された内容をベースとした以下の構成を使用する。
```json
{
  "params": {
    "width":  { "type": "number", "label": "幅", "unit": "mm", "default": 300, "constraint": { "min": 200, "max": 600, "step": 10 } },
    "depth":  { "type": "number", "label": "奥行き", "unit": "mm", "default": 400, "constraint": { "min": 200, "max": 800, "step": 10 } },
    "height": { "type": "number", "label": "高さ", "unit": "mm", "default": 150, "constraint": { "enum": [100, 150, 200] } },
    "color":  { "type": "color", "label": "色", "default": "#cccccc", "constraint": { "enum": ["#cccccc", "#336699", "#993333"] } }
  },
  "shape": {
    "op": "subtract",
    "a": {
      "op": "stretch",
      "shape": { "op": "step", "path": "box-base.step" },
      "cut": [100, 100, 75],
      "delta": ["$width - 200", "$depth - 200", "$height - 150"]
    },
    "b": {
      "op": "translate",
      "shape": { "op": "step", "path": "mounting-hole.step" },
      "xyz": ["$width * 0.5", "$depth - 20", 0]
    }
  },
  "color": "$color"
}
```

## 3. 実装ステップ
今回は計画書の作成のみ。実際の実装フェーズでは以下の順序で進める。
1. `Lambda360Order.tsx` の雛形作成（フォーム部分のUI実装）。
2. JSONツリーをトラバースし、パラメータをバインド・評価するロジック（`evaluateShape(shape, params)`）の実装。
3. `Lambda360Shape.tsx` との統合。
4. `frontend/app/order1/page.tsx` にJSONデータを流し込んで動作確認。
