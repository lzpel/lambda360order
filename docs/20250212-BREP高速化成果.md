# BREPバイナリキャッシュによる高速化（2025/02/12）

## 目的
STEPファイルの読み込みが非常に遅い（DAENモデルで約2分かかる）という課題を解決するため、OpenCASCADE (OCCT) の内部フォーマットであるBREP（Boundary Representation）形式を用いたキャッシュ機構を導入し、読み込み時間を劇的に短縮することを目指しました。

## 手法
`opencascade-rs` ライブラリには標準でBREPの入出力機能が不足していたため、以下の手順で機能を拡張しました。

1.  **`opencascade-rs` のフォークと改造**:
    -   `opencascade-rs` リポジトリをフォークし、C++の `BinTools` （バイナリ形式）および `BRepTools` （テキスト形式）へのバインディングを追加しました。
    -   **変更箇所**:
        -   `opencascade-sys/include/wrapper.hxx`: `write_brep`, `read_brep` (テキスト), `write_brep_bin`, `read_brep_bin` (バイナリ) のC++実装を追加。
        -   `opencascade-sys/src/lib.rs`: 上記C++関数へのFFI定義を追加。
        -   `opencascade/src/primitives/shape.rs`: Rustから安全に呼び出せる `Shape::write_brep_bin` などのメソッドを追加。

2.  **キャッシュロジックの実装**:
    -   初回読み込み時はSTEPファイルを解析し、その形状データを `write_brep_bin` でバイナリ形式 (`.brep`) として保存。
    -   次回以降は、高速なバイナリファイルを `read_brep_bin` で読み込むことで、重いSTEP解析処理をスキップ。

## 結果
検証の結果、**約2800倍** という驚異的な高速化を達成しました。

| 処理 | 時間 | 備考 |
| :--- | :--- | :--- |
| **STEP読み込み** | **約126.06秒** | 従来の解析処理（ボトルネック） |
| **BREPテキスト読み込み** | 約0.091秒 | テキスト形式でも十分高速（約1391倍） |
| **BREPバイナリ読み込み** | **約0.046秒** | **バイナリ形式でさらに倍速（約2744倍）** |

### 特記事項
-   **精度**: 出力されたSTLファイルのサイズがSTEP経由とBREP経由で完全に一致（57,282,252 bytes）しており、幾何情報の欠損がないことを確認しました。
-   **安全性**: バイナリ形式 (`BinTools`) はOCCTのバージョン間で後方互換性が高いため、キャッシュとして利用するには最適です。ただし、将来的なOCCTの大幅アップデートに備え、読み込み失敗時にはSTEPから再生成するフォールバック処理を推奨します（今回は `Result` 型でエラーハンドリング済み）。

## 今後の展望
この高速化により、ユーザー体験（UX）は劇的に向上します。今後は、ブラウザ上での表示（WebGL/Three.js）への最適化や、サーバーサイドでのさらなる並列処理などを検討できます。
