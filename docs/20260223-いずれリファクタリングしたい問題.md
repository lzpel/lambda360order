api/src/step_to_brep.rs この中汚すぎ、ただハートビーツしたいだけなのにこんなにbox pin arcまみれになるのはおかしいと思う

s3のキー設計も改善点がある、拡張子を排除したい、claudeからはそもそもstepファイルとbrepファイルを両方保存するのをやめてbrepだけにしたら？と言われている。

以下を使ってtempにglbを保存したい,temp/sessionは1日だけ、他は180日のキャッシュ。フロントエンドはまずキャッシュヒットを試す。
>s3の消滅時間って特定のパスだけはやめたりできない？基本180日だけど/uploaded以下は一日みたいな
```
できます
**Amazon Web Services の Amazon S3 は「プレフィックス（パス）」ごとに** ライフサイクルルールを分けられます。

つまり、あなたの例：

> 基本 180日
> `/uploaded/` 以下は 1日

は **完全に標準機能で実現可能** です。

---

# 仕組み（要点）

S3 の Lifecycle Rule は：

* バケット単位で複数作れる
* 各ルールに

  * **Prefix（例：`uploaded/`）**
  * または Tag 条件
    を指定できる
* マッチしたオブジェクトだけに適用される

なので：

* Rule A: `""`（全体） → 180日
* Rule B: `"uploaded/"` → 1日

という **上書き構造** にできます。

---

# 実務でよく使う構成（あなたの用途向け）

例えば：

```text
s3://mybucket/
 ├ uploaded/        ← 一時置き場（1日）
 ├ processed/       ← 変換後（180日）
 └ permanent/       ← 永久保存（削除なし）
```

Lifecycle：

### Rule 1（uploaded）

* Prefix: `uploaded/`
* Expiration: 1 day

### Rule 2（default）

* Prefix: ""（全体）
* Expiration: 180 days

### Rule 3（permanent）

* Prefix: `permanent/`
* Expiration: 無し

これで：

* uploaded → 1日
* processed → 180日
* permanent → 無期限

になります。

---

# AWS CLI で書く場合（例）

```bash
aws s3api put-bucket-lifecycle-configuration \
  --bucket YOUR_BUCKET \
  --lifecycle-configuration '{
    "Rules": [
      {
        "ID": "uploaded-1day",
        "Filter": { "Prefix": "uploaded/" },
        "Status": "Enabled",
        "Expiration": { "Days": 1 }
      },
      {
        "ID": "default-180days",
        "Filter": { "Prefix": "" },
        "Status": "Enabled",
        "Expiration": { "Days": 180 }
      }
    ]
  }'
```

---

# 超重要な注意（地味にハマる）

### ✅ より「具体的」な prefix が優先される

`uploaded/` が `""` より勝ちます。

---

### ⚠ 削除は「最大24時間遅延」

Expiration=1 day としても：

* ちょうど24hで消えるわけじゃない
* AWSの非同期GCで数時間〜1日ズレる

これは仕様。

---

# あなたの今の設計とかなり噛み合う

あなたは：

* 認証したくない
* stepを一時アップロード
* hashで管理
* brep生成後は消したい

という流れなので：

```
uploaded/<sha256>.step   ← 1日
processed/<sha256>.brep ← 180日 or 永久
```

はかなり理想形です。

S3 lifecycle はこの用途のために存在してるレベル。

---

もし次に気になりそうなのは：

* presigned URL + uploaded/
* lifecycle と versioning の関係
* 誰かが uploaded に無限PUTした場合の被害上限

このあたり。

必要ならそこも整理します 👍
```