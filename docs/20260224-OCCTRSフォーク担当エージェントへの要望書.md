# 20260224-OCCTRSフォーク担当エージェントへの要望書

対象フォーク: https://github.com/lzpel/opencascade-rs

---

## 事前確認済み：追加不要なAPI

以下2つは **すでに wrap 済み** のため追加不要です。

| API | 実装場所 |
|-----|---------|
| `BRepAlgoAPI_Section` | `opencascade-sys/src/lib.rs` L924-937、`opencascade/src/section.rs` |
| `BRepPrimAPI_MakePrism` | `opencascade-sys/src/lib.rs` L586-598、`opencascade/src/primitives/face.rs` の `extrude()` |

---

## 要望：BRepPrimAPI_MakeHalfSpace の追加

### 目的

`StretchNode` の実装において、形状を任意の平面で2分割する処理が必要です。

現状は `BIG = 1_000_000.0` の巨大ボックスを `intersect` / `subtract` することで代用していますが、数値的に不安定であり本来不要な大量の面を処理させています。`BRepPrimAPI_MakeHalfSpace` を使えば「ある平面の一方側すべて」という真の半無限ソリッドを直接生成できます。

### OCCT の API シグネチャ

```cpp
// BRepPrimAPI_MakeHalfSpace.hxx
// コンストラクタは2種類ある

// (1) Face から生成（主にこちらを使う）
BRepPrimAPI_MakeHalfSpace(const TopoDS_Face& Face, const gp_Pnt& RefPnt);

// (2) Shell から生成
BRepPrimAPI_MakeHalfSpace(const TopoDS_Shell& Shell, const gp_Pnt& RefPnt);
```

- `Face` / `Shell`: 切断面を定義するサーフェス
- `RefPnt`: 取り出したい側にある参照点（半空間はこの点を含む側になる）
- `.Shape()` で `TopoDS_Solid` を取得

### Stretch での利用イメージ

```rust
// Z=50 の平面で切断し、z > 50 の側を取り出す例
// 1. XY平面の大きなFaceを z=50 に配置
// 2. RefPnt = (0, 0, 51) → z > 50 の側が半空間になる
// 3. shape.intersect(&half_space) → 正側
// 4. shape.subtract(&half_space) → 負側
```

---

## 実装パターン（既存コードに倣う）

### ステップ1: `opencascade-sys/include/wrapper.hxx` に include を追加

```cpp
#include <BRepPrimAPI_MakeHalfSpace.hxx>
```

### ステップ2: `opencascade-sys/src/lib.rs` の `extern "C++"` ブロックに追加

既存の `BRepPrimAPI_MakeBox` の宣言（L652-664）に倣います:

```rust
type BRepPrimAPI_MakeHalfSpace;

#[cxx_name = "construct_unique"]
pub fn BRepPrimAPI_MakeHalfSpace_face_ctor(
    face: &TopoDS_Face,
    ref_pnt: &gp_Pnt,
) -> UniquePtr<BRepPrimAPI_MakeHalfSpace>;

pub fn Shape(self: Pin<&mut BRepPrimAPI_MakeHalfSpace>) -> &TopoDS_Shape;
pub fn IsDone(self: &BRepPrimAPI_MakeHalfSpace) -> bool;
```

`wrapper.hxx` に対応する `construct_unique` ヘルパーも追加が必要です（他の `MakeBox` などと同じパターン）。

### ステップ3: `opencascade/src/primitives/shape.rs` に Rust ラッパーを追加

`BRepPrimAPI_MakeBox` の `box_from_corners` メソッド（L299-310）に倣い、
`Shape` の関連関数として追加することを推奨します:

```rust
/// ある平面の片側を表す半空間ソリッドを生成する。
/// face: 切断面を定義するFace
/// ref_pnt: 取り出したい側にある点（この点を含む側が半空間になる）
pub fn half_space(face: &Face, ref_pnt: DVec3) -> Self {
    let pnt = ffi::new_point(ref_pnt.x, ref_pnt.y, ref_pnt.z);
    let face_shape = ffi::cast_face_to_shape(&face.inner);
    let face_topo = ffi::TopoDS_cast_to_face(face_shape);
    let mut hs = ffi::BRepPrimAPI_MakeHalfSpace_face_ctor(face_topo, &pnt);
    Self::from_shape(hs.pin_mut().Shape())
}
```

### 補足: 無限平面 Face の生成方法

呼び出し側でFaceを作るには `BRepBuilderAPI_MakeFace` + `gp_Pln` を使います。
`BRepBuilderAPI_MakeFace(const gp_Pln& P)` はすでに wrap 済みか要確認。
未wrap の場合はあわせて追加が必要です。

---

## 優先度

| 要望 | 優先度 | 理由 |
|------|--------|------|
| `BRepPrimAPI_MakeHalfSpace` | 中 | 現状の巨大ボックス代用で動作はしているが数値安定性の改善に必要 |
| `BRepBuilderAPI_MakeFace(gp_Pln)` | 中 | MakeHalfSpace と合わせて必要になる可能性あり（要確認） |
